rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(orgID) {
      return get(/databases/$(database)/documents/orgs/$(orgID)).data.ownerID == request.auth.uid;
    }

    function incomingData() {
      return request.resource.data;
    }
    
    // Checks if the incoming data has all the specified keys
    function hasAll(fields) {
      return incomingData().keys().hasAll(fields);
    }
    
    function isString(field) {
      return incomingData()[field] is string;
    }
    
    function isNotEmptyString(field) {
      return isString(field) && incomingData()[field].size() > 0;
    }

    function isTimestamp(field) {
      return incomingData()[field] is timestamp;
    }

    // --- Rules ---

    match /users/{userID} {
      allow read, write: if request.auth.uid == userID;
    }
    
    match /orgs/{orgID} {
      function isAdmin() {
        return isOwner(orgID) || exists(/databases/$(database)/documents/orgs/$(orgID)/active-admins/$(request.auth.uid));
      }
      
      // Allow public read for users to find orgs, but writes are restricted
      allow read: if true; 
      
      // Only authenticated users can create an org, and they must be the owner
      allow create: if isAuthenticated() 
                    && incomingData().ownerID == request.auth.uid
                    && hasAll(['name', 'ownerID', 'acceptingAdminRequests'])
                    && isNotEmptyString('name');
                    
      allow write: if isAdmin();
      
      match /admin-requests/{userID} {
        // Users can create a request for themselves
        allow create: if request.auth.uid == userID;
        
        // Users can read their own request; admins can read all
        allow read: if request.auth.uid == userID || isAdmin();
        
        // Only admins can modify requests (approve/deny logic usually handled by cloud functions or admin client)
        allow write: if isAdmin();
      }
      
      match /active-admins/{userID} {
        // SECURE: Only the user themselves or other admins can see this
        allow read: if request.auth.uid == userID || isAdmin();
        allow write: if isAdmin();
      }
      
      match /pending-requests/{requestID} {
        // Allow anyone to create a request (needs validation)
        // TODO: Enforce schema validation for requests here if possible, 
        // but often minimal validation is done here and full validation in logic.
        allow create: if true; 
        
        // Allow anyone to read so that users can see when a space has already
        // been requested but no yet approved.
        allow read: if true;
        
        allow write: if isAdmin();
      } 
     
      match /request-details/{requestID} {
        // Validating the request structure on creation
        allow create: if true 
                      && hasAll(['name', 'email', 'eventName', 'eventStartTime', 'eventEndTime'])
                      && isNotEmptyString('name')
                      && isNotEmptyString('email')
                      && isTimestamp('eventStartTime')
                      && isTimestamp('eventEndTime')
                      && incomingData().eventEndTime > incomingData().eventStartTime;
                      
        allow read: if isAdmin();
        allow write: if isAdmin();
      }
      
      match /denied-requests/{requestID} {
        allow read, write: if isAdmin();
      }
      
      match /confirmed-requests/{requestID} {
        allow read: if true; // Public calendar needs to see confirmed bookings
        allow write: if isAdmin();
      }
      
      match /rooms/{roomID} {
        allow read: if true;
        allow write: if isAdmin() 
                     && (request.resource == null || (hasAll(['name']) && isNotEmptyString('name')));
      }
      
      match /request-logs/{logID} {
        allow create: if "requestID" in incomingData();
        allow read, write: if isAdmin();
      }
    }
  }
}